<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book a Ride - Sharing Yatra</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    /* --- Layout & Sidebar Styles (From Dashboard) --- */
    body {
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #94a3b8;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    #sidebar {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    #sidebar .h-16 {
      background: linear-gradient(to right, #2563eb, #4f46e5);
    }

    #sidebar .h-16 h1 {
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #sidebar nav a {
      transition: all 0.2s ease-in-out;
      color: #4b5563;
    }

    #sidebar nav a:hover {
      background-color: #f3f4f6;
      color: #1f2937;
      transform: translateX(4px);
    }

    #sidebar nav a.bg-gray-200 {
      background: #eff6ff;
      color: #2563eb;
      font-weight: 600;
      border-right: 4px solid #2563eb;
    }

    #sidebar nav a.bg-gray-200 svg {
      color: #2563eb;
    }

    #logoutBtn:hover {
      background-color: #ffebee;
      color: #dc2626;
      transform: translateX(4px);
    }

    #logoutBtn:hover svg {
      color: #dc2626;
    }

    /* --- Booking Form & Modal Styles (From booking.html) --- */
    h1.bg-clip-text {
      background-size: 200% auto;
      animation: gradient-flow 4s ease-in-out infinite;
    }

    @keyframes gradient-flow {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      outline: none;
      ring-width: 0;
    }

    label[for="expressConnect"],
    label[for="scheduleSave"] {
      transition: all 0.2s ease-in-out;
      position: relative;
      overflow: hidden;
    }

    label[for="expressConnect"]:hover,
    label[for="scheduleSave"]:hover {
      border-color: #9ca3af;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
    }

    .peer:checked+label {
      background-color: #eff6ff;
      border-color: #3b82f6;
      transform: scale(1.02);
      box-shadow: 0 4px 12px -2px rgba(59, 130, 246, 0.15);
    }

    .peer:checked+label::after {
      content: '✔';
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #3b82f6;
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes pop-in {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .spinner,
    .modal-spinner {
      border: 2px solid rgba(0, 0, 0, 0.1);
      width: 16px;
      height: 16px;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .spinner {
      border-left-color: #ffffff;
    }

    .modal-spinner {
      border-left-color: #4f46e5;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #scheduleContainer {
      transition: all 0.3s ease-in-out;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
    }

    #scheduleContainer.visible {
      max-height: 500px;
      opacity: 1;
    }

    #submitButton {
      background-image: linear-gradient(to right, #2563eb, #4f46e5);
      border: none;
      box-shadow: 0 4px 15px -3px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease-in-out;
    }

    #submitButton:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px -3px rgba(59, 130, 246, 0.4);
      background-image: linear-gradient(to right, #3b82f6, #6366f1);
    }

    #submitButton:disabled {
      background-image: none;
      background-color: #9ca3af;
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: none;
    }

    #agencyGrid>div {
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease-in-out;
      border: 1px solid #f3f4f6;
    }

    #agencyGrid>div:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    #bookingModal {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    #bookingModal.visible {
      visibility: visible;
      opacity: 1;
    }

    #modalPanel {
      transform: scale(0.95);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #bookingModal.visible #modalPanel {
      transform: scale(1);
      opacity: 1;
    }

    #confirmBookingBtn {
      background-image: linear-gradient(to right, #4f46e5, #3730a3);
      transition: all 0.2s ease;
    }

    #confirmBookingBtn:hover:not(:disabled) {
      background-image: linear-gradient(to right, #6366f1, #4338ca);
      box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.4);
      transform: translateY(-2px);
    }

    #confirmBookingBtn:disabled {
      background-image: none;
      background-color: #a5b4fc;
      cursor: not-allowed;
    }
  </style>
</head>

<body class="bg-gray-100">

  <div class="flex h-screen bg-gray-100">

    <aside id="sidebar"
      class="w-64 flex-shrink-0 bg-white shadow-lg flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static">
      <div class="h-16 flex items-center justify-center border-b">
        <h1 class="text-2xl font-bold text-gray-800">Sharing Yatra</h1>
      </div>

      <nav class="flex-1 px-4 py-6 space-y-2">
        <a href="/dashboard.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
            </path>
          </svg>
          Dashboard
        </a>
        <a href="booking.html" class="flex items-center px-4 py-2 text-gray-700 bg-gray-200 rounded-lg font-semibold">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Book a Ride
        </a>
        <a href="MyBookings.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
            </path>
          </svg>
          My Bookings
        </a>
        <a href="EditProfile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          Profile
        </a>
      </nav>

      <div class="px-4 py-6 border-t">
        <a id="logoutBtn" href="/login.html"
          class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          Logout
        </a>
      </div>
    </aside>

    <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden"></div>

    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="bg-white shadow-sm h-16 flex justify-between items-center px-4 lg:hidden">
        <h1 class="text-2xl font-bold text-gray-800">Sharing Yatra</h1>
        <button id="mobileToggle"
          class="p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
          aria-label="Open sidebar">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </header>
      <main class="flex-1 overflow-y-auto custom-scrollbar p-4 sm:p-6 lg:p-8">

        <h2 class="text-3xl font-bold text-gray-900 mb-6">Book Your Ride </h2>
        <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 sm:p-10">

          <div class="text-center mb-8">
            <h1
              class="text-4xl sm:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
              Sharing Yatra
            </h1>
            <p class="text-gray-500 mt-2"><i>Your Ride, Your Pace</i></p>
          </div>

          <form id="bookingForm" class="space-y-6" novalidate>
            <div class="relative">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div>
                  <label for="from" class="block text-sm font-medium text-gray-700 mb-1">From</label>
                  <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                      </svg>
                    </div>
                    <input type="text" id="from" name="from" required placeholder="e.g., Churchgate" list="station-list"
                      class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                  </div>
                </div>

                <div>
                  <label for="to" class="block text-sm font-medium text-gray-700 mb-1">To</label>
                  <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                      </svg>
                    </div>
                    <input type="text" id="to" name="to" required placeholder="e.g., Thane" list="station-list"
                      class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                  </div>
                </div>
              </div>
              <div id="distanceDisplay" class="text-right text-sm font-semibold text-blue-600 h-5 mt-2 pr-1"></div>
            </div>

            <div class="space-y-4">
              <h3 class="text-sm font-medium text-gray-700">Pickup Address</h3>
              <div>
                <label for="areaInput" class="block text-sm font-medium text-gray-700 mb-1">Area / Landmark</label>
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                      viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.75M9 11.25h6.75M9 15.75h6.75M9 20.25h6.75" />
                    </svg>
                  </div>
                  <input type="text" id="areaInput" name="areaInput" required
                    placeholder="e.g., Near Station, Main Road"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
              </div>

              <div>
                <label for="cityInput" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                      viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M2.25 21h19.5m-18-18h16.5M5.25 6H18.75m-13.5 0V18m13.5 0V6m-6.75 0v.75m0 3v.75m0 3v.75m0 3V18m-3.375-3.028a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM12 9.75a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM12 14.25a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM15.375 9.75a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM15.375 14.25a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM18.75 9.75a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM18.75 14.25a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0z" />
                    </svg>
                  </div>
                  <input type="text" id="cityInput" name="cityInput" required placeholder="e.g., Thane"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
              </div>

              <textarea id="pickupAddress" name="pickupAddress" rows="1" required class="hidden"></textarea>
            </div>

            <div class="space-y-4">
              <h3 class="text-sm font-medium text-gray-700">Choose Your Booking Type</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <input type="radio" id="expressConnect" name="bookingType" value="express_connect" class="hidden peer"
                    checked>
                  <label for="expressConnect"
                    class="block p-4 border-2 border-gray-300 rounded-lg cursor-pointer transition peer-checked:border-blue-500 peer-checked:ring-2 peer-checked:ring-blue-500/50">
                    <span class="font-semibold text-gray-800">Express Connect</span>
                    <p class="text-sm text-gray-500 mt-1">For immediate travel.</p>
                  </label>
                </div>
                <div>
                  <input type="radio" id="scheduleSave" name="bookingType" value="schedule_and_save"
                    class="hidden peer">
                  <label for="scheduleSave"
                    class="block p-4 border-2 border-gray-300 rounded-lg cursor-pointer transition peer-checked:border-blue-500 peer-checked:ring-2 peer-checked:ring-blue-500/50">
                    <span class="font-semibold text-gray-800">Schedule & Save</span>
                    <p class="text-sm text-gray-500 mt-1">For planned trips.</p>
                  </label>
                </div>
              </div>
            </div>

            <div id="scheduleContainer">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-gray-200">
                <div>
                  <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Schedule Date</label>
                  <input type="date" id="date" name="date"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                  <label for="time" class="block text-sm font-medium text-gray-700 mb-1">Schedule Time</label>
                  <input type="time" id="time" name="time"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
              </div>
            </div>
            <div>
              <button type="submit" id="submitButton"
                class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300 disabled:bg-blue-400">
                <span id="buttonText">Search Agency</span>
                <div id="buttonSpinner" class="spinner hidden ml-2"></div>
              </button>
            </div>
          </form>

          <div id="messageArea" class="mt-6 text-center"></div>

          <div id="savedRidesContainer" class="hidden mt-6">
            <h3 class="text-lg font-semibold text-gray-800">Saved Rides near your station</h3>
            <div id="savedRidesList" class="mt-3 space-y-3"></div>
          </div>

          <div id="agencyResultsContainer" class="hidden mt-8">
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold text-gray-800">Available Rides</h2>
              <button id="backToFormBtn" class="text-sm text-blue-600 hover:underline">&larr; Back to Edit</button>
            </div>
            <div id="agencyGrid" class="space-y-4 mt-4">
              </div>
          </div>

          <datalist id="station-list"></datalist>
        </div>

      </main>
    </div>
  </div>

  <div id="bookingModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div id="modalOverlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

    <div id="modalPanel" class="relative w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden">
      <div class="flex justify-between items-center p-4 sm:p-6 border-b border-gray-200">
        <h3 class="text-xl font-semibold text-gray-800">Confirm Your Ride</h3>
        <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
            </path>
          </svg>
        </button>
      </div>

      <div class="p-4 sm:p-6 space-y-4">
        <div class="bg-gray-200 h-48 rounded-lg flex items-center justify-center">
          <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
            </path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </div>
        <div id="modalVehicleDetails" class="space-y-3"></div>
        <div id="modalMessageArea" class="text-center"></div>
      </div>

      <div class="flex flex-col sm:flex-row gap-3 p-4 sm:p-6 bg-gray-50 border-t border-gray-200">
        <button id="cancelBookingBtn"
          class="w-full sm:w-auto px-6 py-3 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
          Cancel
        </button>
        <button id="confirmBookingBtn"
          class="w-full sm:w-full flex-1 flex items-center justify-center px-6 py-3 text-sm font-semibold text-white bg-blue-600 rounded-lg transition hover:bg-blue-700 disabled:opacity-70">
          <span id="confirmButtonText">Confirm Booking</span>
          <div id="confirmButtonSpinner" class="modal-spinner hidden ml-2"></div>
        </button>
      </div>
    </div>
  </div>
  <script>
    // --- All Consts and Functions from booking.html (Unchanged) ---
    const bookingForm = document.getElementById('bookingForm');
    const submitButton = document.getElementById('submitButton');
    const buttonText = document.getElementById('buttonText');
    const buttonSpinner = document.getElementById('buttonSpinner');
    const messageArea = document.getElementById('messageArea');
    const fromInput = document.getElementById('from');
    const toInput = document.getElementById('to');
    const distanceDisplay = document.getElementById('distanceDisplay');
    const stationList = document.getElementById('station-list');
    const expressConnectRadio = document.getElementById('expressConnect');
    const scheduleSaveRadio = document.getElementById('scheduleSave');
    const scheduleContainer = document.getElementById('scheduleContainer');
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const agencyResultsContainer = document.getElementById('agencyResultsContainer');
    const agencyGrid = document.getElementById('agencyGrid');
    const backToFormBtn = document.getElementById('backToFormBtn');
    const areaInput = document.getElementById('areaInput');
    const cityInput = document.getElementById('cityInput');
    const pickupAddressInput = document.getElementById('pickupAddress');
    const bookingModal = document.getElementById('bookingModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelBookingBtn = document.getElementById('cancelBookingBtn');
    const confirmBookingBtn = document.getElementById('confirmBookingBtn');
    const modalVehicleDetails = document.getElementById('modalVehicleDetails');
    const modalMessageArea = document.getElementById('modalMessageArea');
    const confirmButtonText = document.getElementById('confirmButtonText');
    const confirmButtonSpinner = document.getElementById('confirmButtonSpinner');
    const savedRidesContainer = document.getElementById('savedRidesContainer');
    const savedRidesList = document.getElementById('savedRidesList');

    let uniqueStationNames = new Set();
    let calculatedDistance = 0;
    let tempBookingDetails = {};
    let tempSelectedVehicle = {};
    const API_BASE = "https://sharing-yatra-college.vercel.app";

    // --- All functions (getDiscountPercentage, showModal, etc.) are unchanged ---
    function getDiscountPercentage(distance) {
      if (distance <= 0) return 0;
      if (distance <= 5) return 0.02; // 2% for 1-5 km
      if (distance <= 20) return 0.05; // 5% for 6-10 km
      if (distance <= 0) return 0.08; // 8% for 11-20 km
      if (distance <= 30) return 0.12; // 12% for 21-30 km
      return 0.15; // 15% for anything over 30 km
    }
    function showModal() {
      bookingModal.classList.add('visible');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      bookingModal.classList.remove('visible');
      document.body.style.overflow = '';
      setModalLoading(false);
      modalMessageArea.innerHTML = '';
    }

    function setModalLoading(isLoading) {
      confirmBookingBtn.disabled = isLoading;
      confirmButtonText.textContent = isLoading ? 'Booking...' : 'Confirm Booking';
      confirmButtonSpinner.classList.toggle('hidden', !isLoading);
    }

    function displayModalError(message) {
      modalMessageArea.innerHTML = `<p class="p-3 text-sm rounded-lg bg-red-50 text-red-700">${message}</p>`;
    }

    // REPLACE your old populateModal function with this one
    function populateModal(details) {
      modalVehicleDetails.innerHTML = '';
      function createEl(tag, className, text) {
        const el = document.createElement(tag);
        el.className = className;
        el.textContent = text;
        return el;
      }
      function createRow(label, value) {
        const row = document.createElement('div');
        row.className = 'flex justify-between';
        const labelSpan = document.createElement('span');
        labelSpan.className = 'text-gray-500';
        labelSpan.textContent = label;
        const valueStrong = document.createElement('strong');
        valueStrong.className = 'text-gray-800';
        valueStrong.textContent = value;
        row.append(labelSpan, valueStrong);
        return row;
      }
      const divTextCenter = document.createElement('div');
      divTextCenter.className = 'text-center';
      divTextCenter.append(
        createEl('h4', 'text-2xl font-bold text-gray-900', details.vehicleName),
        createEl('p', 'text-sm text-gray-500', details.vehicleInfo)
      );

      // --- UPDATED PRICE DISPLAY ---
      const divPriceCenter = document.createElement('div');
      divPriceCenter.className = 'text-center mt-4';
      divPriceCenter.append(
        createEl('p', 'text-4xl font-extrabold text-indigo-600', details.price) // This is the final price
      );

      // Add discount details if available
      if (details.basePrice && details.discount) {
        const priceDetail = document.createElement('p');
        priceDetail.className = 'text-sm text-gray-500';
        priceDetail.innerHTML = `
          Original: <span class="line-through">${details.basePrice}</span>
          - Discount: <span class="font-semibold text-green-600">${details.discount}</span>
        `;
        divPriceCenter.append(priceDetail);
      } else {
        divPriceCenter.append(
          createEl('p', 'text-sm text-gray-500', 'Approx. total fare')
        );
      }
      // --- END UPDATED PRICE DISPLAY ---

      const divDetails = document.createElement('div');
      divDetails.className = 'space-y-2 pt-4 border-t border-gray-100 mt-4';
      divDetails.append(
        createRow('From:', details.from),
        createRow('To:', details.to),
        createRow('Distance:', `${details.distance} km`),
        createRow('Agency:', details.agencyName)
      );
      modalVehicleDetails.append(divTextCenter, divPriceCenter, divDetails);
    }
    closeModalBtn.addEventListener('click', closeModal);
    cancelBookingBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);

    function updateHiddenPickupAddress() {
      const area = areaInput.value.trim();
      const city = cityInput.value.trim();
      let combinedAddress = area;
      if (area && city) {
        combinedAddress += ', ' + city;
      } else if (city) {
        combinedAddress = city;
      }
      pickupAddressInput.value = combinedAddress;
    }

    async function calculateAndDisplayDistance() {
      const fromValue = fromInput.value.trim();
      const toValue = toInput.value.trim();
      if (!fromValue || !toValue || !uniqueStationNames.has(fromValue) || !uniqueStationNames.has(toValue)) {
        distanceDisplay.textContent = '';
        calculatedDistance = 0;
        return;
      }
      distanceDisplay.textContent = 'Calculating...';
      try {
        const response = await fetch(`${API_BASE}/api/distance?from=${encodeURIComponent(fromValue)}&to=${encodeURIComponent(toValue)}`);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Route not found.');
        }
        const result = await response.json();
        const distance = result.totalDistance;
        calculatedDistance = distance;
        distanceDisplay.textContent = `Total Distance: ${distance.toFixed(2)} km`;
        distanceDisplay.classList.remove('text-red-700');
        distanceDisplay.classList.add('text-green-700');
      } catch (error) {
        distanceDisplay.textContent = error.message.includes('fetch') ? 'Cannot connect to server.' : error.message;
        distanceDisplay.classList.remove('text-green-700');
        distanceDisplay.classList.add('text-red-700');
        calculatedDistance = 0;
      }
    }

    async function displayAgencyResults() {
      setLoading(true, 'Searching Agencies...');
      agencyGrid.innerHTML = '';
      const pickupAddress = tempBookingDetails.pickupAddress;
      try {
        // --- API URL Unchanged ---
        const response = await fetch(`/api/search-rides?address=${encodeURIComponent(pickupAddress)}`);
        if (!response.ok) {
          let errorMsg = 'Could not find agency rides.';
          try {
            const errorData = await response.json();
            errorMsg = errorData.message || errorMsg;
          } catch (e) { }
          throw new Error(errorMsg);
        }
        const agenciesWithVehicles = await response.json();
        if (!agenciesWithVehicles || agenciesWithVehicles.length === 0) {
          if (savedRidesList.innerHTML.trim() === '') {
            displayMessage('Sorry, no rides found for your search.', 'error');
          } else {
            agencyGrid.innerHTML = `<p class="text-sm text-gray-500 text-center col-span-full">No direct agency rides found for this pickup area.</p>`;
          }
        } else {
          agenciesWithVehicles.forEach((agency) => {
            const agencyCard = document.createElement('div');
            agencyCard.className = 'agency-card border border-gray-200 rounded-lg shadow-sm overflow-hidden';
            const header = document.createElement('div');
            header.className = 'p-3 bg-gray-50';
            const h3 = document.createElement('h3');
            h3.className = 'font-bold text-lg text-gray-800';
            h3.textContent = agency.name || 'Unnamed Agency';
            const p = document.createElement('p');
            p.className = 'text-sm text-gray-600';
            p.textContent = agency.address || 'No address';
            header.append(h3, p);
            const vehiclesContainer = document.createElement('div');
            if (!agency.vehicles || agency.vehicles.length === 0) {
              vehiclesContainer.innerHTML = `<p class="p-3 text-sm text-gray-500">No vehicles currently available.</p>`;
            } else {
              agency.vehicles.forEach((vehicle) => {
                const rate = parseFloat(vehicle.rate_per_km);
                if (isNaN(rate) || rate < 0 || calculatedDistance <= 0) {
                  return;
                }

                // --- DISCOUNT LOGIC ADDED HERE ---
                const basePrice = calculatedDistance * rate;
                const discountPercentage = getDiscountPercentage(calculatedDistance);
                const discountAmount = basePrice * discountPercentage;
                const finalFare = basePrice - discountAmount;
                // --- END DISCOUNT LOGIC ---

                const item = document.createElement('div');

                // Dynamic background color based on AC type
                const bgColor =
                  vehicle.ac_type === 'AC'
                    ? 'bg-green-50 hover:bg-green-100 border-green-200'
                    : 'bg-blue-50 hover:bg-blue-100 border-blue-200';

                item.className = `vehicle-item flex justify-between items-center p-4 mb-3 rounded-2xl shadow-sm transition duration-300 border ${bgColor}`;

                // --- Left Side ---
                const left = document.createElement('div');
                left.className = 'flex-1';

                const acLabel =
                  vehicle.ac_type === 'AC'
                    ? '<span class="font-semibold text-green-700">(AC)</span>'
                    : '<span class="font-semibold text-blue-700">(Non-AC)</span>';

                left.innerHTML = `
  <p class="font-semibold text-gray-900 text-base">
    ${vehicle.vehicle_name || 'N/A'} 
    <span class="text-sm text-gray-500 ml-1">(${vehicle.vehicle_type || 'N/A'})</span>
  </p>
  <p class="text-xs text-gray-600 mt-1">
    ${acLabel}
    <span class="ml-2">Model: ${vehicle.model || 'N/A'}</span> |
    <span>Max: ${vehicle.max_capacity || 'N/A'} seats</span>
  </p>
`;

                // --- Right Side ---
                const right = document.createElement('div');
                right.className = 'text-right ml-4';

                right.innerHTML = `
  <p class="font-bold text-lg text-gray-900">₹${finalFare.toFixed(0)}</p>
  <p class="text-xs text-gray-500">
    <span class="line-through">₹${basePrice.toFixed(0)}</span>
    <span class="font-semibold text-green-600 ml-1">
      (${(discountPercentage * 100).toFixed(0)}% off)
    </span>
  </p>
  <button
    class="book-vehicle-btn mt-2 text-xs bg-green-600 text-white font-semibold py-1.5 px-4 rounded-full hover:bg-green-700 transition duration-300"
    data-agency-id="${agency._id}"
    data-vehicle-id="${vehicle._id}"
    data-fare="${finalFare.toFixed(0)}"
    data-discount="${discountAmount.toFixed(2)}"
    data-base-price="${basePrice.toFixed(0)}">
    Book Now
  </button>
`;

                item.append(left, right);
                vehiclesContainer.appendChild(item);

                // --- END UPDATED UI ---

                item.append(left, right);
                vehiclesContainer.appendChild(item);
              });
            }
            agencyCard.append(header, vehiclesContainer);
            agencyGrid.appendChild(agencyCard);
          });
        }
        bookingForm.classList.add('hidden');
        agencyResultsContainer.classList.remove('hidden');
      } catch (error) {
        if (savedRidesList.innerHTML.trim() === '') {
          displayMessage(error.message, 'error');
        } else {
          agencyGrid.innerHTML = `<p class="text-sm text-red-500 text-center col-span-full">Could not load agency rides: ${error.message}</p>`;
        }
        bookingForm.classList.add('hidden');
        agencyResultsContainer.classList.remove('hidden');
      } finally {
        setLoading(false, 'Search Agency');
      }
    }


    // REPLACE your old fetchAndDisplaySharedRides function with this one
    async function fetchAndDisplaySharedRides(details) {
      savedRidesList.innerHTML = '';
      savedRidesContainer.classList.add('hidden');
      let searchDate, searchTime;
      if (details.bookingType === 'schedule_and_save' && details.date && details.time) {
        searchDate = details.date;
        searchTime = details.time;
      } else {
        const now = new Date();
        searchDate = now.toISOString().split('T')[0];
        searchTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      }
      const queryParams = new URLSearchParams({
        from: details.from,
        to: details.to,
        date: searchDate,
        time: searchTime
      });
      // --- API URL Unchanged ---
      const url = `/api/matched-saved-rides?${queryParams.toString()}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.success || !data.rides || data.rides.length === 0) {
          return;
        }
        savedRidesContainer.classList.remove('hidden');
        data.rides.forEach(ride => {
          const agencyName = ride.agency ? ride.agency.name : 'Private Ride';
          const dateTime = `${ride.date || ''} ${ride.time || ''}`.trim();
          const fromStation = ride.stations.find(s => s.name.toLowerCase() === details.from.toLowerCase());
          const rideTimeInfo = fromStation ?
            `<span class="font-semibold text-blue-700">Departs ${fromStation.name} at ${fromStation.time}</span>` :
            `${ride.from} → ${ride.to}`;
          
          const el = document.createElement('div');
          el.className = 'p-3 border border-gray-200 rounded-lg flex justify-between items-start';
          const leftDiv = document.createElement('div');
          leftDiv.className = 'flex-1';
          const agencyText = document.createElement('div');
          agencyText.className = 'text-sm text-gray-700';
          agencyText.textContent = `${agencyName} • ${ride.vehicle ? ride.vehicle.vehicle_name : ''}`;
          const routeDiv = document.createElement('div');
          routeDiv.className = 'font-semibold';
          routeDiv.textContent = `${ride.from} → ${ride.to} `;
          const dateSpan = document.createElement('span');
          dateSpan.className = 'text-xs text-gray-500';
          dateSpan.textContent = `(${dateTime})`;
          routeDiv.appendChild(dateSpan);
          const timeInfoDiv = document.createElement('div');
          timeInfoDiv.className = 'text-sm text-gray-500 mt-1';
          timeInfoDiv.innerHTML = rideTimeInfo;
          leftDiv.append(agencyText, routeDiv, timeInfoDiv);
          
          const rightDiv = document.createElement('div');
          rightDiv.className = 'ml-4 text-right';
          const joinBtn = document.createElement('button');
          joinBtn.className = 'join-saved-btn text-xs bg-blue-600 text-white font-semibold py-1 px-3 rounded-full';
          joinBtn.dataset.parentId = ride.parentBookingId;
          joinBtn.textContent = 'Request to Join';
          
          const fareDiv = document.createElement('div');
          fareDiv.className = 'text-xs text-gray-500 mt-2';

          // --- DISCOUNT LOGIC FOR JOIN RIDE ---
          const distanceForFare = parseFloat(calculatedDistance);
          const rate = ride.vehicle ? parseFloat(ride.vehicle.rate_per_km) : NaN;

          if (!isNaN(distanceForFare) && distanceForFare > 0 && !isNaN(rate) && rate > 0) {
              const basePrice = distanceForFare * rate;
              const discountPercentage = getDiscountPercentage(distanceForFare);
              // const discountAmount = basePrice * discountPercentage;
              // const finalFare = basePrice - discountAmount;

              // joinBtn.dataset.fare = finalFare.toFixed(0);
              // joinBtn.dataset.discount = discountAmount.toFixed(2);

const firstDiscountAmount = basePrice * discountPercentage; // This is your first discount
        
        // 1. Calculate the price after the first discount
          const priceAfterFirstDiscount = basePrice - firstDiscountAmount;
        
        // 2. Calculate the additional 10% discount on the new price
        const additionalDiscountAmount = priceAfterFirstDiscount * 0.20; 
        
        // 3. This is your corrected final fare
          const finalFare = priceAfterFirstDiscount - additionalDiscountAmount; 
        
        // 4. Calculate the total combined discount amount
        const totalDiscountAmount = firstDiscountAmount + additionalDiscountAmount;

          joinBtn.dataset.fare = finalFare.toFixed(0);
          joinBtn.dataset.discount = totalDiscountAmount.toFixed(2); // Store the total discount


            
              fareDiv.innerHTML = `
                <span class="font-semibold text-gray-800">₹${finalFare.toFixed(0)}</span>
                <span class="line-through ml-1">₹${basePrice.toFixed(0)}</span>
              `;
          } else {
              const fare = ride.fare || 0;
              joinBtn.dataset.fare = fare;
              joinBtn.dataset.discount = 0;
              fareDiv.textContent = fare ? `₹${fare}` : '—';
          }
          // --- END DISCOUNT LOGIC ---
          
          rightDiv.append(joinBtn, fareDiv);
          el.append(leftDiv, rightDiv);
          savedRidesList.appendChild(el);
        });
      } catch (err) {
        console.error("Error loading saved rides:", err);
        savedRidesContainer.classList.add('hidden');
      }
    }
    bookingForm.addEventListener('submit', function (event) {
      event.preventDefault();
      messageArea.innerHTML = '';
      agencyGrid.innerHTML = '';
      savedRidesList.innerHTML = '';
      savedRidesContainer.classList.add('hidden');
      if (!bookingForm.checkValidity()) {
        displayMessage('Please fill all required fields.', 'error');
        return;
      }
      if (calculatedDistance <= 0) {
        displayMessage('Could not calculate distance. Please select valid stations.', 'error');
        return;
      }
      const formData = new FormData(bookingForm);
      tempBookingDetails = {
        from: formData.get('from'),
        to: formData.get('to'),
        pickupAddress: formData.get('pickupAddress'),
        area: formData.get('areaInput'),
        city: formData.get('cityInput'),
        bookingType: formData.get('bookingType'),
        totalDistance: calculatedDistance.toFixed(2)
      };
      if (tempBookingDetails.bookingType === 'schedule_and_save') {
        tempBookingDetails.date = formData.get('date');
        tempBookingDetails.time = formData.get('time');
      }
      fetchAndDisplaySharedRides(tempBookingDetails);
      displayAgencyResults();
    });

    // REPLACE your old agencyGrid 'click' listener with this one
    agencyGrid.addEventListener('click', async function (event) {
      if (!event.target.classList.contains('book-vehicle-btn')) return;
      
      const selectedButton = event.target;
      const vehicleItem = selectedButton.closest('.vehicle-item');
      const agencyCard = selectedButton.closest('.agency-card');
      // Read data from the button and vehicle item
      const vehicleName = vehicleItem.querySelector('.font-semibold').textContent;
      const vehicleInfo = vehicleItem.querySelector('.text-xs').textContent;
      const agencyName = agencyCard.querySelector('h3').textContent;

      // Read ALL data attributes from the button
      const basePrice = selectedButton.dataset.basePrice;
      const discount = selectedButton.dataset.discount;
      const finalFare = selectedButton.dataset.fare;

      // Store details for final booking
      tempSelectedVehicle = {
        agencyId: selectedButton.dataset.agencyId,
        vehicleId: selectedButton.dataset.vehicleId,
        fare: finalFare,
        discount: discount // <-- ADDED DISCOUNT
      };

      // Populate modal with new discount info
      populateModal({
        vehicleName,
        vehicleInfo,
        price: `₹${finalFare}`, // Final price
        basePrice: `₹${basePrice}`, // Original price
        discount: `₹${parseFloat(discount).toFixed(2)}`, // Discount amount
        agencyName,
        from: tempBookingDetails.from,
        to: tempBookingDetails.to,
        distance: tempBookingDetails.totalDistance
      });

      showModal();
    });
    confirmBookingBtn.addEventListener('click', async () => {
      setModalLoading(true);
      modalMessageArea.innerHTML = '';
      const finalBookingData = {
        ...tempBookingDetails,
        ...tempSelectedVehicle
      };
      try {
        // --- API URL Unchanged ---
        const response = await fetch(`${API_BASE}/api/bookings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(finalBookingData)
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message || 'Booking failed.');
        closeModal();
        const successMessage = `
          <h3 class="text-lg font-semibold text-green-800">Request Sent!</h3>
          <p class="text-gray-600 mt-1">Your Booking ID is: <strong class="font-mono">${result.bookingId || 'SY-12345'}</strong></p>
          <p class="text-gray-500 text-sm mt-2">Your request has been sent to the agency for approval.</p>`;
        displayMessage(successMessage, 'success');
        agencyResultsContainer.classList.add('hidden');
        savedRidesContainer.classList.add('hidden');
        bookingForm.classList.remove('hidden');
        calculatedDistance = 0;
        distanceDisplay.textContent = '';
      } catch (error) {
        displayModalError(error.message);
        setModalLoading(false);
      }
    });

    backToFormBtn.addEventListener('click', () => {
      agencyResultsContainer.classList.add('hidden');
      savedRidesContainer.classList.add('hidden');
      bookingForm.classList.remove('hidden');
      messageArea.innerHTML = '';
    });

    function setLoading(isLoading, text = 'Search Agency') {
      submitButton.disabled = isLoading;
      buttonText.textContent = isLoading ? text : 'Search Agency';
      buttonSpinner.classList.toggle('hidden', !isLoading);
    }

    async function loadStations() {
      try {
        const response = await fetch('stationdata.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const fullStationData = await response.json();
        stationList.innerHTML = '';
        fullStationData.lines.forEach(line => {
          line.routes.forEach(route => {
            route.stations.forEach(station => {
              uniqueStationNames.add(station.station_name);
            });
          });
        });
        uniqueStationNames.forEach(stationName => {
          const option = document.createElement('option');
          option.value = stationName;
          stationList.appendChild(option);
        });
      } catch (error) {
        console.error("Could not load station data:", error);
      }
    }

    function setMinDateTime() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      dateInput.min = `${yyyy}-${mm}-${dd}`;
      if (dateInput.value === `${yyyy}-${mm}-${dd}`) {
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        timeInput.min = `${hh}:${min}`;
      } else {
        timeInput.min = '';
      }
    }

    function toggleScheduleSection() {
      if (scheduleSaveRadio.checked) {
        scheduleContainer.classList.add('visible');
        dateInput.required = true;
        timeInput.required = true;
        setMinDateTime();
      } else {
        scheduleContainer.classList.remove('visible');
        dateInput.required = false;
        timeInput.required = false;
      }
    }

    // REPLACE your old 'join-saved-btn' click listener with this one
    document.addEventListener('click', async function (e) {
      if (!e.target.classList.contains('join-saved-btn')) {
        return;
      }
      messageArea.innerHTML = '';
      const btn = e.target;
      btn.disabled = true;
      const parentId = btn.dataset.parentId;

      // --- UPDATED FARE/DISCOUNT LOGIC ---
      // Read fare and discount directly from the button's dataset
      const calculatedJoinFare = btn.dataset.fare || 0;
      const calculatedJoinDiscount = btn.dataset.discount || 0;
      // --- END UPDATED LOGIC ---

      if (!parentId) {
        alert("Error: Could not find ride ID. Please refresh.");
        btn.disabled = false;
        return;
      }
      updateHiddenPickupAddress();
      const currentPickupAddress = pickupAddressInput.value;
      const currentArea = areaInput.value;
      const currentCity = cityInput.value;
      if (!currentPickupAddress) {
        alert("Please fill pickup address (Area / City) in the main form before requesting to join.");
        btn.disabled = false;
        return;
      }
      const userFromValue = fromInput.value.trim();
      const userToValue = toInput.value.trim();
      if (!userFromValue || !userToValue) {
        alert("Please ensure 'From' and 'To' stations are selected in the main form before joining.");
        btn.disabled = false;
        return;
      }
      try {
        // --- UPDATED PAYLOAD ---
        const payload = {
          parentBookingId: parentId,
          pickupAddress: currentPickupAddress,
          area: currentArea,
          city: currentCity,
          userFrom: userFromValue,
          userTo: userToValue,
          userDistance: calculatedDistance,
          calculatedFare: calculatedJoinFare,
          discount: calculatedJoinDiscount // <-- ADDED DISCOUNT
        };
        // --- END UPDATED PAYLOAD ---

        // --- API URL Unchanged ---
        const res = await fetch(`${API_BASE}/api/join-saved-ride`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.message || 'Failed to send join request');
        }
        displayMessage(`<strong class="text-green-800">Join request sent!</strong><div class="text-sm text-gray-600 mt-1">Request Booking ID: <code>${data.bookingId}</code></div>`, 'success');
        btn.textContent = "Requested";
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-gray-400');
        btn.disabled = true;
        agencyResultsContainer.classList.add('hidden');
        savedRidesContainer.classList.add('hidden');
        bookingForm.classList.remove('hidden');
      } catch (err) {
        console.error("Join request error:", err);
        displayMessage(err.message || 'Could not send join request', 'error');
        btn.disabled = false;
      }
    });
    function displayMessage(message, type) {
      messageArea.innerHTML = '';
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = message;
      while (tempDiv.firstChild) {
        messageArea.appendChild(tempDiv.firstChild);
      }
      messageArea.className = `mt-6 text-center p-4 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`;
    }

    fromInput.addEventListener('input', calculateAndDisplayDistance);
    toInput.addEventListener('input', calculateAndDisplayDistance);
    expressConnectRadio.addEventListener('change', toggleScheduleSection);
    scheduleSaveRadio.addEventListener('change', toggleScheduleSection);
    dateInput.addEventListener('change', setMinDateTime);
    areaInput.addEventListener('input', updateHiddenPickupAddress);
    cityInput.addEventListener('input', updateHiddenPickupAddress);
    areaInput.addEventListener('change', updateHiddenPickupAddress);
    cityInput.addEventListener('change', updateHiddenPickupAddress);


    // --- 
    // FIX 3: Replaced with responsive sidebar JavaScript
    // ---
    function wireInteractions() {
      // --- NEW: Mobile Sidebar Toggle Logic ---
      const toggleBtn = document.getElementById("mobileToggle");
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("sidebarBackdrop");

      function openSidebar() {
        sidebar.classList.remove("-translate-x-full"); // Slides sidebar in
        backdrop.classList.remove("hidden"); // Shows backdrop
      }

      function closeSidebar() {
        sidebar.classList.add("-translate-x-full"); // Slides sidebar out
        backdrop.classList.add("hidden"); // Hides backdrop
      }

      if (toggleBtn && sidebar && backdrop) {
        // Toggle button click
        toggleBtn.addEventListener("click", () => {
          const isOpen = !sidebar.classList.contains("-translate-x-full");
          if (isOpen) {
            closeSidebar();
          } else {
            openSidebar();
          }
        });
        // Backdrop click
        backdrop.addEventListener("click", closeSidebar);
      }

      // --- Logout (Unchanged, respects API_BASE) ---
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            await fetch(`${API_BASE}/logout`, { method: "POST", credentials: "include" });
          } catch (_) { /* noop */ }
          window.location.href = "/login.html";
        });
      }
    }

    // --- Initialize Page ---
    (async function init() {
      // From booking.html's DOMContentLoaded
      await loadStations(); // Await this as it's async
      toggleScheduleSection();

      // From the original layout
      wireInteractions();
    })();
  </script>
</body>

</html>
